<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maryamâ€™s Chatbot</title>
  <style>
    :root { --bg:#0b0b0c; --panel:#121214; --line:#1e1e22; --text:#eee; --you:#c9f; --bot:#9fe29f; }
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:880px;margin:0 auto;padding:24px}
    h1{font-size:1.2rem;margin:0 0 8px}
    #status{opacity:.8;font-size:.9rem;margin:0 0 12px}
    #log{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px;height:60vh;overflow:auto}
    .msg{margin:10px 0;line-height:1.5;white-space:pre-wrap}
    .you{color:var(--you)}
    .bot{color:var(--bot)}
    form{display:flex;gap:8px;margin-top:12px}
    input,button{font:inherit}
    input{flex:1;padding:12px;border-radius:10px;border:1px solid var(--line);background:var(--panel);color:var(--text)}
    button{padding:12px 16px;border-radius:10px;border:0;background:#4b9cff;color:#fff;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:8px;margin-top:8px}
    .hint{opacity:.7;font-size:.9rem;margin-top:6px}
    .small{font-size:.85rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ¤– Maryamâ€™s AI</h1>
    <p id="status">Loading the tiny modelâ€¦ first time can take a minute.</p>

    <div id="log" aria-live="polite" aria-busy="true"></div>

    <form id="chat">
      <input id="inp" placeholder="Ask me anythingâ€¦" autocomplete="off" />
      <button id="send" disabled>Send</button>
    </form>

    <div class="row">
      <button id="reset" disabled>Reset chat</button>
      <button id="stop" disabled>Stop</button>
    </div>

    <div class="hint small">Tip: Chrome/Edge recommended (WebGPU). After the first load, the model is cached.</div>
  </div>

  <script type="module">
    // Runs fully in the browser â€” no server, no API key needed.
    import { CreateWebWorkerMLCEngine } from "https://esm.run/@mlc-ai/web-llm";

    const MODEL = "Llama-3.2-1B-Instruct-q4f32_1-MLC"; // small model = faster load

    const log = document.getElementById('log');
    const inp = document.getElementById('inp');
    const btnSend = document.getElementById('send');
    const btnReset = document.getElementById('reset');
    const btnStop = document.getElementById('stop');
    const statusEl = document.getElementById('status');

    // Keep a simple in-page chat history
    const history = [{ role: "system", content: "You are a friendly, concise assistant that helps Maryam." }];

    // UI helpers
    function addMessage(role, text="") {
      const div = document.createElement('div');
      div.className = 'msg ' + (role === 'user' ? 'you' : 'bot');
      div.textContent = (role === 'user' ? 'You: ' : 'AI: ') + text;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
      return div;
    }
    function setBusy(b) {
      log.setAttribute('aria-busy', String(b));
      btnSend.disabled = b || !engineReadyFlag;
      btnReset.disabled = b || !engineReadyFlag;
      btnStop.disabled = !b;
      inp.disabled = b || !engineReadyFlag;
    }

    // Initialize engine in a web worker for smoother UI
    let engine, engineReadyFlag = false, currentStreamAbort;
    (async () => {
      setBusy(true);
      statusEl.textContent = "Loading the tiny modelâ€¦";
      engine = await CreateWebWorkerMLCEngine(
        new Worker("https://esm.run/@mlc-ai/web-llm/workers/worker.js", { type: "module" }),
        {
          model: MODEL,
          logLevel: "info",
          initProgressCallback: (p) => {
            const pct = Math.round((p.progress || 0) * 100);
            statusEl.textContent = p.text ? `${p.text} (${pct}%)` : `Loadingâ€¦ (${pct}%)`;
          },
        }
      );
      engineReadyFlag = true;
      statusEl.textContent = "Ready âœ… â€” ask something!";
      setBusy(false);
      btnSend.disabled = false;
      btnReset.disabled = false;
      inp.focus();
    })().catch(err => {
      statusEl.textContent = "Failed to load model. Try refreshing the page.";
      console.error(err);
      setBusy(false);
    });

    // Handle sending
    document.getElementById('chat').addEventListener('submit', async (e) => {
      e.preventDefault();
      const q = inp.value.trim();
      if (!q || !engineReadyFlag) return;

      // Add user + placeholder bot message
      history.push({ role: "user", content: q });
      addMessage('user', q);
      inp.value = "";
      const botDiv = addMessage('assistant', "â€¦"); // will live-update

      // Compose and stream response
      setBusy(true);
      let answer = "";
      try {
        // Allow stopping mid-answer
        const controller = new AbortController();
        currentStreamAbort = () => controller.abort();

        const stream = await engine.chat.completions.create({
          messages: history,
          stream: true,
          signal: controller.signal,
        });

        for await (const chunk of stream) {
          const delta = chunk?.choices?.[0]?.delta?.content || "";
          if (delta) {
            answer += delta;
            botDiv.textContent = "AI: " + answer; // live streaming text
            log.scrollTop = log.scrollHeight;
          }
        }
        history.push({ role: "assistant", content: answer || "(no output)" });
      } catch (err) {
        if (err?.name === "AbortError") {
          botDiv.textContent = "AI: (stopped)";
        } else {
          botDiv.textContent = "AI: Sorryâ€”there was an error. Try again.";
          console.error(err);
        }
      } finally {
        currentStreamAbort = null;
        setBusy(false);
        inp.focus();
      }
    });

    // Reset chat
    btnReset.addEventListener('click', () => {
      log.innerHTML = "";
      history.length = 0;
      history.push({ role: "system", content: "You are a friendly, concise assistant that helps Maryam." });
      addMessage('bot', "Chat cleared. How can I help?");
      inp.focus();
    });

    // Stop streaming
    btnStop.addEventListener('click', () => {
      if (currentStreamAbort) currentStreamAbort();
    });

    // Enter key convenience on mobile
    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        // let the form submit handler run
      }
    });
  </script>
</body>
</html>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0b0b0c">
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
  }
</script>

